<!DOCTYPE html>
<html>
<head>
    <title>Audio Record and Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/lamejs/lame.min.js"></script>
</head>
<body>
    <h1>Record Audio as MP3</h1>
    <button id="startRecord">Start Recording</button>
    <button id="stopRecord" disabled>Stop Recording</button>
    <audio id="audioPlayback" controls></audio>
    <button id="uploadAudio" disabled>Upload Audio</button>
    <div id="transcriptionResult"></div>

    <script>
        let recorder, gumStream;
        let audioChunks = [];
        let mp3Encoder;
        let sampleRate;
        let mp3Data = [];

        document.getElementById('startRecord').addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                gumStream = stream;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                sampleRate = audioContext.sampleRate;

                const input = audioContext.createMediaStreamSource(stream);
                recorder = audioContext.createScriptProcessor(4096, 1, 1);

                mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 128); // Mono channel, 128kbps
                mp3Data = [];

                recorder.onaudioprocess = function(e) {
                    const samples = e.inputBuffer.getChannelData(0);
                    const mp3Buffer = mp3Encoder.encodeBuffer(samples);
                    if (mp3Buffer.length > 0) {
                        mp3Data.push(mp3Buffer);
                    }
                };

                input.connect(recorder);
                recorder.connect(audioContext.destination);

                document.getElementById('stopRecord').disabled = false;
                this.disabled = true;
            });
        });

        document.getElementById('stopRecord').addEventListener('click', function() {
            recorder.disconnect();
            gumStream.getAudioTracks()[0].stop();
            const mp3Buffer = mp3Encoder.flush();   // Finish encoding
            if (mp3Buffer.length > 0) {
                mp3Data.push(mp3Buffer);
            }
            const blob = new Blob(mp3Data, {type: 'audio/mp3'});
            const audioUrl = URL.createObjectURL(blob);
            document.getElementById('audioPlayback').src = audioUrl;
            document.getElementById('uploadAudio').disabled = false;
            this.disabled = true;
            document.getElementById('startRecord').disabled = false;
        });

        document.getElementById('uploadAudio').addEventListener('click', function() {
            const blob = new Blob(mp3Data, {type: 'audio/mp3'});
            const formData = new FormData();
            formData.append('audio', blob, 'recording.mp3');

            fetch('/upload_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); // Handle the response data
                if(data.transcription) {
                    document.getElementById('transcriptionResult').textContent = 'Transcription: ' + data.transcription;
                } else if(data.error) {
                    document.getElementById('transcriptionResult').textContent = 'Error: ' + data.error;
                }
            })
            .catch(error => {
            console.error(error)
            document.getElementById('transcriptionResult').textContent = 'Error: ' + error;
            });

            mp3Data = [];
            this.disabled = true;
        });
    </script>
</body>
</html>
